local UI_ELEMENT = {
    main = '7375134760238520544',
    consumerObject = {
        equip = {{
            btn = "7375134760238520544_543",
            img = "7375134760238520544_544",
            lv = "7375134760238520544_545"
        }, {
            btn = "7375134760238520544_546",
            img = "7375134760238520544_547",
            lv = "7375134760238520544_548"
        }, {
            btn = "7375134760238520544_549",
            img = "7375134760238520544_550",
            lv = "7375134760238520544_551"
        }, {
            btn = "7375134760238520544_552",
            img = "7375134760238520544_553",
            lv = "7375134760238520544_554"
        }, {
            btn = "7375134760238520544_555",
            img = "7375134760238520544_556",
            lv = "7375134760238520544_557"
        }},
        item = {{
            btn = "7375134760238520544_558",
            img = "7375134760238520544_559",
            num = "7375134760238520544_560"
        }, {
            btn = "7375134760238520544_562",
            img = "7375134760238520544_563",
            num = "7375134760238520544_564"
        }, {
            btn = "7375134760238520544_565",
            img = "7375134760238520544_566",
            num = "7375134760238520544_567"
        }, {
            btn = "7375134760238520544_568",
            img = "7375134760238520544_569",
            num = "7375134760238520544_570"
        }, {
            btn = "7375134760238520544_571",
            img = "7375134760238520544_572",
            num = "7375134760238520544_573"
        }},
        name = "7375134760238520544_434",
        status = "7375134760238520544_438"
    },
    producerObject = {
        equip = {{
            btn = "7375134760238520544_581",
            img = "7375134760238520544_582",
            lv = "7375134760238520544_583"
        }, {
            btn = "7375134760238520544_585",
            img = "7375134760238520544_586",
            lv = "7375134760238520544_587"
        }, {
            btn = "7375134760238520544_589",
            img = "7375134760238520544_590",
            lv = "7375134760238520544_591"
        }, {
            btn = "7375134760238520544_593",
            img = "7375134760238520544_594",
            lv = "7375134760238520544_595"
        }, {
            btn = "7375134760238520544_597",
            img = "7375134760238520544_598",
            lv = "7375134760238520544_599"
        }},
        item = {{
            btn = "7375134760238520544_601",
            img = "7375134760238520544_602",
            num = "7375134760238520544_603"
        }, {
            btn = "7375134760238520544_605",
            img = "7375134760238520544_606",
            num = "7375134760238520544_607"
        }, {
            btn = "7375134760238520544_609",
            img = "7375134760238520544_610",
            num = "7375134760238520544_611"
        }, {
            btn = "7375134760238520544_613",
            img = "7375134760238520544_614",
            num = "7375134760238520544_615"
        }, {
            btn = "7375134760238520544_617",
            img = "7375134760238520544_618",
            num = "7375134760238520544_619"
        }},
        name = "7375134760238520544_624",
        status = "7375134760238520544_622"
    },
    lockBtn = "7375134760238520544_329",
    confirmBtn = "7375134760238520544_333",
    feeText = "7375134760238520544_336",
    RIGHT_NAV_MENUS = {
        ["7375134760238520544_133"] = {"weapon", "7375134760238520544_134"},
        ["7375134760238520544_135"] = {"hat", "7375134760238520544_136"},
        ["7375134760238520544_137"] = {"clothes", "7375134760238520544_138"},
        ["7375134760238520544_139"] = {"shoes", "7375134760238520544_140"},
        ["7375134760238520544_141"] = {"ring", "7375134760238520544_142"},
        ["7375134760238520544_143"] = {"bracelet", "7375134760238520544_144"},
        ["7375134760238520544_145"] = {"shield", "7375134760238520544_146"},
        ["7375134760238520544_147"] = {"items", "7375134760238520544_148"}
    },
    -- 品质
    QUALITY_BG = {
        ["普通"] = {"8_1118247136_1704453713", "8_1118247136_1710515583"},
        ["精良"] = {"8_1118247136_1705398630", "8_1118247136_1705214792"},
        ["完美"] = {"8_1118247136_1705398618", "8_1118247136_1704451287"},
        ["史诗"] = {"8_1118247136_1705398641", "8_1118247136_1710515556"},
        ["传说"] = {"8_1118247136_1705398636", "8_1118247136_1710515564"},
        ["神话"] = {"8_1118247136_1705398647", "8_1118247136_1710515571"},
        ["至尊"] = {"8_1118247136_1705398625", "8_1118247136_1710515526"}
    },
    -- 背包-右侧-所有单元格
    RIGHT_CELLS = {"7375134760238520544_9", "7375134760238520544_13", "7375134760238520544_17",
                   "7375134760238520544_21", "7375134760238520544_25", "7375134760238520544_29",
                   "7375134760238520544_33", "7375134760238520544_37", "7375134760238520544_41",
                   "7375134760238520544_45", "7375134760238520544_49", "7375134760238520544_53",
                   "7375134760238520544_57", "7375134760238520544_61", "7375134760238520544_65",
                   "7375134760238520544_69", "7375134760238520544_73", "7375134760238520544_77",
                   "7375134760238520544_81", "7375134760238520544_85", "7375134760238520544_89",
                   "7375134760238520544_93", "7375134760238520544_97", "7375134760238520544_101",
                   "7375134760238520544_107", "7375134760238520544_111", "7375134760238520544_115",
                   "7375134760238520544_119", "7375134760238520544_123", "7375134760238520544_127"},
    FEN_YE = {
        TEXT = "7375134760238520544_6",
        NEXT = "7375134760238520544_4",
        PREV = "7375134760238520544_5"
    },
    PANEL = {
        right = {
            panel = "7375134760238520544_150",
            tran = "7375134760238520544_149",
            icon_bg = "7375134760238520544_153",
            icon = "7375134760238520544_154",
            panel_title = "7375134760238520544_152",
            panel_bg = "7375134760238520544_151",
            type = "7375134760238520544_155",
            pinzhi = "7375134760238520544_156",
            lv = "7375134760238520544_157",
            gonjili = "7375134760238520544_161",
            hp = "7375134760238520544_163",
            other_attr = {{"7375134760238520544_170", "7375134760238520544_171"}, -- 附加属性 { 文本， 数值 }
            {"7375134760238520544_172", "7375134760238520544_173"},
                          {"7375134760238520544_174", "7375134760238520544_175"}},
            other_effect = "7375134760238520544_176", -- 附加效果
            ok = "7375134760238520544_166"
        },
        items = {
            panel = "7375134760238520544_179", -- 总面板
            panel_title = "7375134760238520544_181", -- 标题
            panel_bg = "7375134760238520544_180", -- 面板品质背景
            icon_bg = "7375134760238520544_182", -- 图标背景
            icon = "7375134760238520544_183", -- 图标
            type = "7375134760238520544_184", -- 类型
            pinzhi = "7375134760238520544_185", -- 品质
            lv = "7375134760238520544_186", -- 等级
            desc = "7375134760238520544_191", -- 描述
            ok = "7375134760238520544_189"
        },
        left = {
            panel = "7375134760238520544_343",
            tran = "7375134760238520544_625",
            icon_bg = "7375134760238520544_346",
            icon = "7375134760238520544_347",
            panel_title = "7375134760238520544_345",
            panel_bg = "7375134760238520544_344",
            type = "7375134760238520544_348",
            pinzhi = "7375134760238520544_349",
            lv = "7375134760238520544_350",
            gonjili = "7375134760238520544_354",
            hp = "7375134760238520544_356",
            other_attr = {{"7375134760238520544_361", "7375134760238520544_362"}, -- 附加属性 { 文本， 数值 }
            {"7375134760238520544_363", "7375134760238520544_364"},
                          {"7375134760238520544_365", "7375134760238520544_366"}},
            other_effect = "7375134760238520544_367" -- 附加效果
        },
        left_items = {
            panel = "7375134760238520544_397", -- 总面板
            panel_title = "7375134760238520544_399", -- 标题
            panel_bg = "7375134760238520544_398", -- 面板品质背景
            icon_bg = "7375134760238520544_400", -- 图标背景
            icon = "7375134760238520544_401", -- 图标
            type = "7375134760238520544_402", -- 类型
            pinzhi = "7375134760238520544_403", -- 品质
            lv = "7375134760238520544_404", -- 等级
            desc = "7375134760238520544_409" -- 描述
        }
    },
    quit = "7375134760238520544_280"
}

local isBaifengbiNums = {50004, 50005, 50004, 50006, 50008, 50009, 50010, 50011, 50012, 50013, 50014}

local localData = {
    selectMenuType = {},
    selectObjectId = {},
    pagination = {}
}

-- 玩家交易信息
local currentTradeInfo = {}

-- 当前房间内所有交易订单信息
local tradeList = {}

-- 限制交易品质判断
local function QualityLimitCheck(itemid)
    local iteminfo = ALL_BACKPACK_ITEMS[itemid]
    if iteminfo.type == '材料' or iteminfo.type == '消耗品' then
        if iteminfo.quality == QUALITY_ENUM[6] or iteminfo.quality == QUALITY_ENUM[7] then
            return false
        end
    else
        if iteminfo.quality == QUALITY_ENUM[7] then
            return false
        end
    end

    return true
end

-- 深拷贝
local function clone(object)
    local lookup_table = {}
    local function _copy(object)
        if type(object) ~= "table" then
            return object
        elseif lookup_table[object] then
            return lookup_table[object]
        end
        local new_table = {}
        lookup_table[object] = new_table
        for key, value in pairs(object) do
            new_table[_copy(key)] = _copy(value)
        end
        return setmetatable(new_table, getmetatable(object))
    end
    return _copy(object)
end

-- 获取装备图片
local function getItemIcon(itemid)
    local _, index = Valuegroup:getGroupNoByValue(21, "道具类型组", itemid, 0)
    local _, iconid = Valuegroup:getValueNoByName(18, "道具图片组", index, 0)
    return iconid
end

-- 显示交易面板，双方面板同时显示, 创建交易订单，订单号为：消费者ID_生产者ID
local function createTradeInfo(consumerUid, producerUid)
    -- 主动点击交易的玩家为"消费者 consumer"，对方为"生产者 producer"
    local tradeInfo = {
        consumer = {
            uid = consumerUid,
            equip = {},
            item = {},
            backpack = {},
            lock = false,
            confirm = false,
            fee = 0
        },
        producer = {
            uid = producerUid,
            equip = {},
            item = {},
            backpack = {},
            lock = false,
            confirm = false,
            fee = 0
        },
        status = 'process'
    }

    tradeInfo.consumer.backpack = CopyTableDeep(PlayerBackpack[consumerUid])
    tradeInfo.producer.backpack = CopyTableDeep(PlayerBackpack[producerUid])

    local tradeNo = consumerUid .. producerUid .. os.time()

    tradeList[tradeNo] = tradeInfo

    currentTradeInfo[consumerUid] = {
        tradeNo = tradeNo,
        role = "consumer"
    }
    currentTradeInfo[producerUid] = {
        tradeNo = tradeNo,
        role = "producer"
    }

    -- Player:openUIView(consumerUid, UI_ELEMENT.main)

    localData.selectMenuType[consumerUid] = 'weapon'
    localData.selectMenuType[producerUid] = 'weapon'

    localData.selectObjectId[consumerUid] = nil
    localData.selectObjectId[producerUid] = nil

    Player:openUIView(producerUid, UI_ELEMENT.main)
end

-- 显示右侧玩家背包
local function showRightBackpackCell(uid, type)
    for _, elementId in ipairs(UI_ELEMENT.RIGHT_CELLS) do
        Customui:hideElement(uid, UI_ELEMENT.main, elementId)
    end

    localData.selectMenuType[uid] = type

    local tradeNo = currentTradeInfo[uid].tradeNo
    local role = currentTradeInfo[uid].role
    local backPack = tradeList[tradeNo][role].backpack
    if localData.pagination[uid] == nil then
        localData.pagination[uid] = {
            current = 1,
            total = 0
        }
    end

    if type == "items" then
        localData.pagination[uid].total = math.floor(#backPack.items / 30) + 1
    else
        localData.pagination[uid].total = math.floor(#backPack.undressed[type] / 30) + 1
    end

    local playerObjs = (type == "items") and backPack.items or backPack.undressed[type]

    local start = (localData.pagination[uid].current - 1) * 30 + 1
    local endNum = localData.pagination[uid].current * 30

    for i = start, endNum do
        if playerObjs[i] ~= nil then
            local objid = (type == "items") and playerObjs[i][1] or playerObjs[i]

            local itemInfo = ALL_BACKPACK_ITEMS[objid]
            local cellIdx = (i % 30 == 0) and 30 or i % 30
            local bgElementId = UI_ELEMENT.RIGHT_CELLS[cellIdx]
            local iconElementId = increment_string(bgElementId)
            local textElementId = increment_string(iconElementId)

            local qualityElementId = UI_ELEMENT.QUALITY_BG[itemInfo.quality][1]
            local levelText = (type == "items") and tostring(playerObjs[i][2]) or "lv" .. itemInfo.lv

            local _, index = Valuegroup:getGroupNoByValue(21, "道具类型组", objid, 0)
            local _, iconid = Valuegroup:getValueNoByName(18, "道具图片组", index, 0)

            Customui:setTexture(uid, UI_ELEMENT.main, bgElementId, qualityElementId)
            Customui:setText(uid, UI_ELEMENT.main, textElementId, levelText)
            Customui:setTexture(uid, UI_ELEMENT.main, iconElementId, iconid)
            Customui:showElement(uid, UI_ELEMENT.main, bgElementId)
        end
    end

    local _, bpLimit = VarLib2:getPlayerVarByName(uid, 3, "背包容量")
    local currentBPNum = #backPack['undressed']['weapon'] + #backPack['undressed']['hat'] +
                             #backPack['undressed']['clothes'] + #backPack['undressed']['shoes'] +
                             #backPack['undressed']['ring'] + #backPack['undressed']['bracelet'] +
                             #backPack['undressed']['shield'] + #backPack['items']

    Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.FEN_YE.TEXT, "物品:" .. currentBPNum .. "/" .. bpLimit)

end

local function handlePaginationLogic(uid, ui)
    if ui == UI_ELEMENT.FEN_YE.NEXT then
        if localData.pagination[uid].current < localData.pagination[uid].total then
            localData.pagination[uid]['current'] = localData.pagination[uid]['current'] + 1
            showRightBackpackCell(uid, localData.selectMenuType[uid])
        end
    elseif ui == UI_ELEMENT.FEN_YE.PREV then
        if localData.pagination[uid]['current'] > 1 then
            localData.pagination[uid]['current'] = localData.pagination[uid]['current'] - 1
            showRightBackpackCell(uid, localData.selectMenuType[uid])
        end
    end
end

-- 显示左侧交易面板
local function showLeftTradeItemCell(uid)
    local tradeNo = currentTradeInfo[uid].tradeNo
    local role = currentTradeInfo[uid].role

    local consumer = tradeList[tradeNo].consumer
    local producer = tradeList[tradeNo].producer

    local _, consumerName = Player:getNickname(consumer.uid)
    local _, producerName = Player:getNickname(producer.uid)
    -- 交易对象
    Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.consumerObject.name, consumerName)
    Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.producerObject.name, producerName)

    if consumer.lock then
        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.consumerObject.status, "已锁定")
        Customui:setColor(uid, UI_ELEMENT.main, UI_ELEMENT.consumerObject.status, "0xF7D067")
        if consumer.confirm then
            Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.consumerObject.status, "已确认")
            Customui:setColor(uid, UI_ELEMENT.main, UI_ELEMENT.consumerObject.status, "0xFF6600")

        end
    else
        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.consumerObject.status, "未锁定")
        Customui:setColor(uid, UI_ELEMENT.main, UI_ELEMENT.consumerObject.status, "0xffffff")
    end

    if producer.lock then
        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.producerObject.status, "已锁定")
        Customui:setColor(uid, UI_ELEMENT.main, UI_ELEMENT.producerObject.status, "0xF7D067")
        if producer.confirm then
            Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.producerObject.status, "已确认")
            Customui:setColor(uid, UI_ELEMENT.main, UI_ELEMENT.producerObject.status, "0xFF6600")
        end
    else
        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.producerObject.status, "未锁定")
        Customui:setColor(uid, UI_ELEMENT.main, UI_ELEMENT.producerObject.status, "0xffffff")
    end

    -- 消费者装备
    for i, equipObject in ipairs(UI_ELEMENT.consumerObject.equip) do
        if consumer.equip[i] == nil then
            Customui:hideElement(uid, UI_ELEMENT.main, equipObject.btn)
            Customui:hideElement(uid, UI_ELEMENT.main, equipObject.img)
            Customui:hideElement(uid, UI_ELEMENT.main, equipObject.lv)
        else
            local iconid = getItemIcon(consumer.equip[i])
            local itemInfo = ALL_BACKPACK_ITEMS[consumer.equip[i]]

            Customui:setTexture(uid, UI_ELEMENT.main, equipObject.btn, UI_ELEMENT.QUALITY_BG[itemInfo['quality']][1])
            Customui:setTexture(uid, UI_ELEMENT.main, equipObject.img, iconid)
            Customui:setText(uid, UI_ELEMENT.main, equipObject.lv, "lv" .. itemInfo.lv)

            Customui:showElement(uid, UI_ELEMENT.main, equipObject.img)
            Customui:showElement(uid, UI_ELEMENT.main, equipObject.lv)
            Customui:showElement(uid, UI_ELEMENT.main, equipObject.btn)
        end
    end

    -- 消费者道具
    for i, itemObject in ipairs(UI_ELEMENT.consumerObject.item) do
        if consumer.item[i] == nil then
            Customui:hideElement(uid, UI_ELEMENT.main, itemObject.btn)
            Customui:hideElement(uid, UI_ELEMENT.main, itemObject.img)
            Customui:hideElement(uid, UI_ELEMENT.main, itemObject.num)
        else
            local iconid = getItemIcon(consumer.item[i][1])
            local itemInfo = ALL_BACKPACK_ITEMS[consumer.item[i][1]]

            Customui:setTexture(uid, UI_ELEMENT.main, itemObject.btn, UI_ELEMENT.QUALITY_BG[itemInfo['quality']][1])
            Customui:setTexture(uid, UI_ELEMENT.main, itemObject.img, iconid)
            Customui:setText(uid, UI_ELEMENT.main, itemObject.num, consumer.item[i][2])

            Customui:showElement(uid, UI_ELEMENT.main, itemObject.img)
            Customui:showElement(uid, UI_ELEMENT.main, itemObject.num)
            Customui:showElement(uid, UI_ELEMENT.main, itemObject.btn)
        end
    end

    -- 生产者装备
    for i, equipObject in ipairs(UI_ELEMENT.producerObject.equip) do
        if producer.equip[i] == nil then
            Customui:hideElement(uid, UI_ELEMENT.main, equipObject.btn)
            Customui:hideElement(uid, UI_ELEMENT.main, equipObject.img)
            Customui:hideElement(uid, UI_ELEMENT.main, equipObject.lv)
        else
            local iconid = getItemIcon(producer.equip[i])
            local itemInfo = ALL_BACKPACK_ITEMS[producer.equip[i]]
            Customui:setTexture(uid, UI_ELEMENT.main, equipObject.btn, UI_ELEMENT.QUALITY_BG[itemInfo['quality']][1])
            Customui:setTexture(uid, UI_ELEMENT.main, equipObject.img, iconid)
            Customui:setText(uid, UI_ELEMENT.main, equipObject.lv, "lv" .. itemInfo.lv)

            Customui:showElement(uid, UI_ELEMENT.main, equipObject.img)
            Customui:showElement(uid, UI_ELEMENT.main, equipObject.lv)
            Customui:showElement(uid, UI_ELEMENT.main, equipObject.btn)
        end
    end

    -- 生产者道具
    for i, itemObject in ipairs(UI_ELEMENT.producerObject.item) do
        if producer.item[i] == nil then
            Customui:hideElement(uid, UI_ELEMENT.main, itemObject.btn)
            Customui:hideElement(uid, UI_ELEMENT.main, itemObject.img)
            Customui:hideElement(uid, UI_ELEMENT.main, itemObject.num)
        else
            local iconid = getItemIcon(producer.item[i][1])
            local itemInfo = ALL_BACKPACK_ITEMS[producer.item[i][1]]
            Customui:setTexture(uid, UI_ELEMENT.main, itemObject.btn, UI_ELEMENT.QUALITY_BG[itemInfo['quality']][1])
            Customui:setTexture(uid, UI_ELEMENT.main, itemObject.img, iconid)
            Customui:setText(uid, UI_ELEMENT.main, itemObject.num, producer.item[i][2])

            Customui:showElement(uid, UI_ELEMENT.main, itemObject.img)
            Customui:showElement(uid, UI_ELEMENT.main, itemObject.num)
            Customui:showElement(uid, UI_ELEMENT.main, itemObject.btn)
        end
    end

    -- 手续费
    print(tradeList[tradeNo][role].fee)
    Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.feeText, tradeList[tradeNo][role].fee .. "")
end


-- 交易面板菜单栏切换处理
local function handleNavMenusChange(uid, uielement)
    if UI_ELEMENT.RIGHT_NAV_MENUS[uielement] == nil then
        return
    end

    for eleId, arr in pairs(UI_ELEMENT.RIGHT_NAV_MENUS) do
        if eleId ~= uielement then
            Customui:setTexture(uid, UI_ELEMENT.main, eleId, "8_1118247136_1705214511") -- 未选中效果
            Customui:setColor(uid, UI_ELEMENT.main, UI_ELEMENT.RIGHT_NAV_MENUS[eleId][2], "0xf7f7f7") -- 未选中
        else
            Customui:setTexture(uid, UI_ELEMENT.main, uielement, "8_1118247136_1704451218") -- 已选中效果
            Customui:setColor(uid, UI_ELEMENT.main, UI_ELEMENT.RIGHT_NAV_MENUS[uielement][2], "0x4e5251") -- 已选中效果
        end
    end

    localData.pagination[uid] = {
        current = 1,
        total = 0
    }

    localData.selectMenuType[uid] = UI_ELEMENT.RIGHT_NAV_MENUS[uielement][1]

    showRightBackpackCell(uid, localData.selectMenuType[uid])
end

-- 交易面板打开UI逻辑
local function handleTradePanelUIShow(event)
    if event.CustomUI ~= UI_ELEMENT.main then
        return
    end

    if currentTradeInfo[event.eventobjid] == nil then
        local _, tagetId = VarLib2:getPlayerVarByName(event.eventobjid, 6, "交易请求玩家")
        createTradeInfo(event.eventobjid, tagetId)
    end
    handleNavMenusChange(event.eventobjid, '7375134760238520544_133') -- 初始化菜单栏UI状态

    showRightBackpackCell(event.eventobjid, 'weapon')
    showLeftTradeItemCell(event.eventobjid)
end
ScriptSupportEvent:registerEvent('UI.Show', handleTradePanelUIShow)

-- 整理装备逻辑
local function handleSortCells(uid)
    local menuType = localData.selectMenuType[uid]

    local tradeNo = currentTradeInfo[uid].tradeNo
    local role = currentTradeInfo[uid].role
    local backPack = tradeList[tradeNo][role].backpack

    if menuType ~= 'items' then
        table.sort(backPack.undressed[menuType], function(a, b)
            local itemA = ALL_BACKPACK_ITEMS[a]
            local itemB = ALL_BACKPACK_ITEMS[b]
            if itemA.quality == itemB.quality then
                return itemA.lv > itemB.lv
            else
                return findIndex(QUALITY_ENUM, itemA.quality) > findIndex(QUALITY_ENUM, itemB.quality)
            end
        end)

    else
        table.sort(backPack.items, function(a, b)
            local itemA = ALL_BACKPACK_ITEMS[a[1]]
            local itemB = ALL_BACKPACK_ITEMS[b[1]]
            if itemA.quality == itemB.quality then
                return itemA.lv > itemB.lv
            else
                return findIndex(QUALITY_ENUM, itemA.quality) > findIndex(QUALITY_ENUM, itemB.quality)
            end
        end)
    end

    showRightBackpackCell(uid, menuType)
end

-- 物品单元格点击逻辑(显示右侧面板)
local function handleRightCellItemClick(uid, uielement)
    if isInArray(UI_ELEMENT.RIGHT_CELLS, uielement) == false then
        return
    end

    local tradeNo = currentTradeInfo[uid].tradeNo
    local role = currentTradeInfo[uid].role
    local backPack = tradeList[tradeNo][role].backpack

    local selectIndex = (localData.pagination[uid]['current'] - 1) * 30 + findIndex(UI_ELEMENT.RIGHT_CELLS, uielement)

    local selectItemId = (localData.selectMenuType[uid] == "items") and backPack.items[selectIndex][1] or
                             backPack.undressed[localData.selectMenuType[uid]][selectIndex]
    localData.selectObjectId[uid] = selectItemId

    local iteminfo = ALL_BACKPACK_ITEMS[selectItemId]

    -- 右侧面板开始显示
    if localData.selectMenuType[uid] == "items" then

        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.items.panel_title, iteminfo.name)
        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.items.type, "类型: " .. iteminfo.type)
        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.items.pinzhi, "品质: " .. iteminfo.quality)
        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.items.lv, "等级: " .. iteminfo.lv)

        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.items.desc, iteminfo.desc)

        Customui:setTexture(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.items.panel_bg,
            UI_ELEMENT.QUALITY_BG[iteminfo['quality']][2])
        Customui:setTexture(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.items.icon_bg,
            UI_ELEMENT.QUALITY_BG[iteminfo['quality']][1])

        local iconid = getItemIcon(selectItemId)
        Customui:setTexture(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.items.icon, iconid)

        Customui:showElement(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.items.panel)
        Customui:showElement(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.right.tran)
    else
        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.right.panel_title, iteminfo.name)
        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.right.type, "类型: " .. iteminfo.type)
        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.right.pinzhi, "品质: " .. iteminfo.quality)
        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.right.lv, "等级: " .. iteminfo.lv)
        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.right.gonjili, "+" .. iteminfo.atk)
        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.right.hp, "+" .. iteminfo.hp)
        Customui:setTexture(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.right.panel_bg,
            UI_ELEMENT.QUALITY_BG[iteminfo['quality']][2])
        Customui:setTexture(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.right.icon_bg,
            UI_ELEMENT.QUALITY_BG[iteminfo['quality']][1])

        local iconid = getItemIcon(selectItemId)

        Customui:setTexture(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.right.icon, iconid)

        for i, v in ipairs(UI_ELEMENT.PANEL.right.other_attr) do
            if iteminfo.otherAttr ~= nil then
                if iteminfo.otherAttr[i] ~= nil then
                    if isInArray(isBaifengbiNums, iteminfo.otherAttr[i][1]) then
                        Customui:setText(uid, UI_ELEMENT.main, v[1], ITEMS_OTHER_ATTRS[iteminfo.otherAttr[i][1]])
                        Customui:setText(uid, UI_ELEMENT.main, v[2], tostring(iteminfo.otherAttr[i][2] * 100) .. "%")
                    else
                        Customui:setText(uid, UI_ELEMENT.main, v[1], ITEMS_OTHER_ATTRS[iteminfo.otherAttr[i][1]])
                        Customui:setText(uid, UI_ELEMENT.main, v[2], iteminfo.otherAttr[i][2])
                    end

                else
                    Customui:setText(uid, UI_ELEMENT.main, v[1], "")
                    Customui:setText(uid, UI_ELEMENT.main, v[2], "")
                end
                Customui:showElement(uid, UI_ELEMENT.main, v[1])
                Customui:showElement(uid, UI_ELEMENT.main, v[2])
            else
                Customui:hideElement(uid, UI_ELEMENT.main, v[1])
                Customui:hideElement(uid, UI_ELEMENT.main, v[2])
            end
        end

        if iteminfo.otherEffect ~= nil then
            Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.right.other_effect,
                string.gsub(ITEMS_OTHER_ATTRS[iteminfo.otherEffect[1]], 'XX', iteminfo.otherEffect[2]))
        else
            Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.right.other_effect, "")
        end

        Customui:showElement(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.right.panel)
        Customui:showElement(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.right.tran)
    end
end

-- 左侧单元格点击事件（显示左侧面板）
local function handleLeftCellItemClick(uid, uielement)

    local selectRole = nil
    local selectType = nil
    local selectIndex = nil

    -- 判断点击的是否是所属cell
    for i, equipObject in pairs(UI_ELEMENT.consumerObject.equip) do
        if uielement == equipObject.btn then
            selectRole = "consumer"
            selectType = "equip"
            selectIndex = i
        end
    end

    for i, equipObject in pairs(UI_ELEMENT.consumerObject.item) do
        if uielement == equipObject.btn then
            selectRole = "consumer"
            selectType = "item"
            selectIndex = i
        end
    end

    for i, equipObject in pairs(UI_ELEMENT.producerObject.equip) do
        if uielement == equipObject.btn then
            selectRole = "producer"
            selectType = "equip"
            selectIndex = i
        end
    end

    for i, equipObject in pairs(UI_ELEMENT.producerObject.item) do
        if uielement == equipObject.btn then
            selectRole = "producer"
            selectType = "item"
            selectIndex = i
        end
    end

    if selectRole == nil or selectType == nil or selectIndex == nil then
        return
    end

    -- 判断点击cell是否存在物品
    local tradeNo = currentTradeInfo[uid].tradeNo
    local role = currentTradeInfo[uid].role

    local itemid = nil
    if selectType == 'item' then
        itemid = tradeList[tradeNo][selectRole].item[selectIndex][1]
    else
        itemid = tradeList[tradeNo][selectRole].equip[selectIndex]
    end

    if itemid == nil then
        return
    end

    local iteminfo = ALL_BACKPACK_ITEMS[itemid]

    -- 开始显示面板
    if selectType == 'item' then
        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left_items.panel_title, iteminfo.name)
        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left_items.type, "类型: " .. iteminfo.type)
        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left_items.pinzhi, "品质: " .. iteminfo.quality)
        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left_items.lv, "等级: " .. iteminfo.lv)

        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left_items.desc, iteminfo.desc)

        Customui:setTexture(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left_items.panel_bg,
            UI_ELEMENT.QUALITY_BG[iteminfo['quality']][2])
        Customui:setTexture(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left_items.icon_bg,
            UI_ELEMENT.QUALITY_BG[iteminfo['quality']][1])

        local iconid = getItemIcon(itemid)
        Customui:setTexture(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left_items.icon, iconid)

        Customui:showElement(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left_items.panel)
        Customui:showElement(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left.tran)
    else
        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left.panel_title, iteminfo.name)
        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left.type, "类型: " .. iteminfo.type)
        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left.pinzhi, "品质: " .. iteminfo.quality)
        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left.lv, "等级: " .. iteminfo.lv)
        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left.gonjili, "+" .. iteminfo.atk)
        Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left.hp, "+" .. iteminfo.hp)
        Customui:setTexture(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left.panel_bg,
            UI_ELEMENT.QUALITY_BG[iteminfo['quality']][2])
        Customui:setTexture(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left.icon_bg,
            UI_ELEMENT.QUALITY_BG[iteminfo['quality']][1])

        local iconid = getItemIcon(itemid)

        Customui:setTexture(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left.icon, iconid)

        for i, v in ipairs(UI_ELEMENT.PANEL.left.other_attr) do
            if iteminfo.otherAttr ~= nil then
                if iteminfo.otherAttr[i] ~= nil then
                    if isInArray(isBaifengbiNums, iteminfo.otherAttr[i][1]) then
                        Customui:setText(uid, UI_ELEMENT.main, v[1], ITEMS_OTHER_ATTRS[iteminfo.otherAttr[i][1]])
                        Customui:setText(uid, UI_ELEMENT.main, v[2], tostring(iteminfo.otherAttr[i][2] * 100) .. "%")
                    else
                        Customui:setText(uid, UI_ELEMENT.main, v[1], ITEMS_OTHER_ATTRS[iteminfo.otherAttr[i][1]])
                        Customui:setText(uid, UI_ELEMENT.main, v[2], iteminfo.otherAttr[i][2])
                    end

                else
                    Customui:setText(uid, UI_ELEMENT.main, v[1], "")
                    Customui:setText(uid, UI_ELEMENT.main, v[2], "")
                end
                Customui:showElement(uid, UI_ELEMENT.main, v[1])
                Customui:showElement(uid, UI_ELEMENT.main, v[2])
            else
                Customui:hideElement(uid, UI_ELEMENT.main, v[1])
                Customui:hideElement(uid, UI_ELEMENT.main, v[2])
            end
        end

        if iteminfo.otherEffect ~= nil then
            Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left.other_effect,
                string.gsub(ITEMS_OTHER_ATTRS[iteminfo.otherEffect[1]], 'XX', iteminfo.otherEffect[2]))
        else
            Customui:setText(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left.other_effect, "")
        end

        Customui:showElement(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left.panel)
        Customui:showElement(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left.tran)
    end

end

local function handlePanelHide(uid, uielement)
    if uielement == UI_ELEMENT.PANEL.left.tran then
        Customui:hideElement(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left_items.panel)
        Customui:hideElement(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left.panel)
        Customui:hideElement(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.left.tran)
    end
    if uielement == UI_ELEMENT.PANEL.right.tran then
        Customui:hideElement(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.items.panel)
        Customui:hideElement(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.right.panel)
        Customui:hideElement(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.right.tran)
    end
end

-- 锁定交易物品按钮
local function lockPanel(uid, elementId)
    if elementId ~= UI_ELEMENT.lockBtn then
        return
    end

    local tradeNo = currentTradeInfo[uid].tradeNo
    local role = currentTradeInfo[uid].role

    if tradeList[tradeNo][role].lock then
        Player:notifyGameInfo2Self(uid, "你已锁定交易物品，无法更改")
        return
    end

    tradeList[tradeNo][role].lock = true
    Player:notifyGameInfo2Self(uid, "你已锁定交易物品")

    showLeftTradeItemCell(tradeList[tradeNo].consumer.uid)
    showLeftTradeItemCell(tradeList[tradeNo].producer.uid)
end

-- 确定交易按钮
local function confirmTrade(uid, elementId)
    if elementId ~= UI_ELEMENT.confirmBtn then
        return
    end

    local tradeNo = currentTradeInfo[uid].tradeNo
    local role = currentTradeInfo[uid].role

    local myTradeInfo = nil
    local targetTradeInfo = nil

    if role == 'consumer' then
        myTradeInfo = tradeList[tradeNo].consumer
        targetTradeInfo = tradeList[tradeNo].producer
    else
        myTradeInfo = tradeList[tradeNo].producer
        targetTradeInfo = tradeList[tradeNo].consumer
    end

    if myTradeInfo.lock == false then
        Player:notifyGameInfo2Self(uid, "你还没有锁定物品")
        return
    end

    local _, myXianyu = VarLib2:getPlayerVarByName(myTradeInfo.uid, 3, "仙玉")
    local _, targetXianyu = VarLib2:getPlayerVarByName(targetTradeInfo.uid, 3, "仙玉")

    if myXianyu < myTradeInfo.fee then
        Player:notifyGameInfo2Self(myTradeInfo.uid, "你的仙玉数量不足")
        Player:notifyGameInfo2Self(targetTradeInfo.uid, "对方仙玉数量不足无法完成交易")
        return
    end

    if targetXianyu < targetTradeInfo.fee then
        Player:notifyGameInfo2Self(myTradeInfo.uid, "对方仙玉数量不足")
        Player:notifyGameInfo2Self(targetTradeInfo.uid, "你的仙玉数量不足无法完成交易")
        return
    end


    myTradeInfo.confirm = true

    -- TODO: 添加buff 用于 当buff存在时，双方都不能操作
    if targetTradeInfo.confirm == false then
        Player:notifyGameInfo2Self(uid, "你已确定交易，等待对方确定后开始交易")
        showLeftTradeItemCell(tradeList[tradeNo].consumer.uid)
        showLeftTradeItemCell(tradeList[tradeNo].producer.uid)
        return
    end

    if tradeList[tradeNo].status ~= 'process' then
        Player:notifyGameInfo2Self(uid, "当前交易订单状态异常或已完成")
        return
    end

    -- 开始交易内容

    local myTempBackpack = CopyTableDeep(PlayerBackpack[myTradeInfo.uid])
    local targetTempBackpack = CopyTableDeep(PlayerBackpack[targetTradeInfo.uid])

    -- 我方数据处理
    for i, itemId in ipairs(myTradeInfo.equip) do
        local iteminfo = ALL_BACKPACK_ITEMS[itemId]
        local itemType = ITEM_TYPE_ENUMS[iteminfo.type]

        local itemIndex = findIndex(myTempBackpack.undressed[itemType], itemId)

        if itemIndex == nil then
            Player:notifyGameInfo2Self(uid, "交易异常，当前交易取消")
            return
        end

        table.remove(myTempBackpack.undressed[itemType], itemIndex)
        table.insert(targetTempBackpack.undressed[itemType], itemId)
    end

    for i, itemObject in ipairs(myTradeInfo.item) do
        print(itemObject)
        local checkItem = false
        for i, temMyItemObject in pairs(myTempBackpack.items) do
            if temMyItemObject[1] == itemObject[1] then
                checkItem = true
                if temMyItemObject[2] < itemObject[2] then
                    checkItem = false
                end
            end
        end

        if checkItem == false then
            Player:notifyGameInfo2Self(uid, "交易异常，当前交易取消")
            return
        end

        local index = -1
        for i, targetItemBp in ipairs(targetTempBackpack.items) do
            if targetItemBp[1] == itemObject[1] then
                targetItemBp[2] = targetItemBp[2] + itemObject[2]
                index = i
            end
        end

        if index == -1 then
            table.insert(targetTempBackpack.items, itemObject)
        end

        for i, temMyItemObject in pairs(myTempBackpack.items) do
            if temMyItemObject[1] == itemObject[1] then
                if temMyItemObject[2] == itemObject[2] then
                    -- temMyItemObject[2] = 0
                    table.remove(myTempBackpack.items, i)
                else
                    temMyItemObject[2] = temMyItemObject[2] - itemObject[2]
                end
                break
            end
        end

        -- 遍历表并删除值为 nil 的索引
        -- for key, value in pairs(myTempBackpack.items) do
        --     if value[2] == 0 then
        --         myTempBackpack.items[key] = nil
        --     end
        -- end
    end

    -- 对方数据处理
    for i, itemId in ipairs(targetTradeInfo.equip) do
        local iteminfo = ALL_BACKPACK_ITEMS[itemId]
        local itemType = ITEM_TYPE_ENUMS[iteminfo.type]

        local itemIndex = findIndex(targetTempBackpack.undressed[itemType], itemId)

        if itemIndex == nil then
            Player:notifyGameInfo2Self(uid, "交易异常，当前交易取消")
            return
        end

        table.remove(targetTempBackpack.undressed[itemType], itemIndex)
        table.insert(myTempBackpack.undressed[itemType], itemId)
    end

    for i, itemObject in ipairs(targetTradeInfo.item) do
        print(itemObject)
        local checkItem = false
        for i, temMyItemObject in pairs(targetTempBackpack.items) do
            if temMyItemObject[1] == itemObject[1] then
                checkItem = true
                if temMyItemObject[2] < itemObject[2] then
                    checkItem = false
                end
            end
        end

        if checkItem == false then
            Player:notifyGameInfo2Self(uid, "交易异常，当前交易取消")
            return
        end

        local index = -1
        for i, targetItemBp in ipairs(myTempBackpack.items) do
            if targetItemBp[1] == itemObject[1] then
                targetItemBp[2] = targetItemBp[2] + itemObject[2]
                index = i
            end
        end

        if index == -1 then
            table.insert(myTempBackpack.items, itemObject)
        end

        for i, temMyItemObject in pairs(targetTempBackpack.items) do
            if temMyItemObject[1] == itemObject[1] then
                if temMyItemObject[2] == itemObject[2] then
                    table.remove(targetTempBackpack.items, i)
                    -- temMyItemObject[2] = 0
                else
                    temMyItemObject[2] = temMyItemObject[2] - itemObject[2]
                end
                break
            end
        end

        -- 遍历表并删除值为 nil 的索引
        -- for key, value in pairs(targetTempBackpack.items) do
        --     if value[2] == 0 then
        --         targetTempBackpack.items[key] = nil
        --     end
        -- end
    end

    -- TODO: 扣除手续费
    VarLib2:setPlayerVarByName(myTradeInfo.uid, 3, "仙玉", myXianyu - myTradeInfo.fee)
    VarLib2:setPlayerVarByName(targetTradeInfo.uid, 3, "仙玉", targetXianyu - targetTradeInfo.fee)

    -- 同步背包
    local ret = CloudSever:setDataListBykey(MINI_CLOUD_TABLE, "player_" .. myTradeInfo.uid, myTempBackpack)
    local ret = CloudSever:setDataListBykey(MINI_CLOUD_TABLE, "player_" .. targetTradeInfo.uid, targetTempBackpack)
    PlayerBackpack.init(myTradeInfo.uid)
    PlayerBackpack.init(targetTradeInfo.uid)

    tradeList[tradeNo].status = 'done'

    local consumer = tradeList[tradeNo].consumer
    local producer = tradeList[tradeNo].producer

    localData.selectMenuType[consumer.uid] = nil
    localData.selectMenuType[producer.uid] = nil
    localData.pagination[consumer.uid] = nil
    localData.pagination[producer.uid] = nil
    localData.selectObjectId[consumer.uid] = nil
    localData.selectObjectId[producer.uid] = nil

    currentTradeInfo[consumer.uid] = nil
    currentTradeInfo[producer.uid] = nil
    Player:hideUIView(consumer.uid, UI_ELEMENT.main)
    Player:hideUIView(producer.uid, UI_ELEMENT.main)

    Player:notifyGameInfo2Self(consumer.uid, "交易已完成")
    Player:notifyGameInfo2Self(producer.uid, "交易已完成")
end

-- 计算手续费
local function caculateTradeFee(uid)
    local tradeNo = currentTradeInfo[uid].tradeNo
    local role = currentTradeInfo[uid].role

    local myTradeInfo = nil
    local targetTradeInfo = nil

    if role == 'consumer' then
        myTradeInfo = tradeList[tradeNo].consumer
        targetTradeInfo = tradeList[tradeNo].producer
    else
        myTradeInfo = tradeList[tradeNo].producer
        targetTradeInfo = tradeList[tradeNo].consumer
    end

    local tempCheckData = {
        my = {
            chuanshuotuposhi = 0,
            shishi = 0,
            chuanshuo = 0,
            shenhua = 0
        },
        target = {
            chuanshuotuposhi = 0,
            shishi = 0,
            chuanshuo = 0,
            shenhua = 0
        }
    }

    for i, equip in ipairs(myTradeInfo.equip) do
        local iteminfo = ALL_BACKPACK_ITEMS[equip]
        if iteminfo.quality == "史诗" then
            tempCheckData.my.shishi = tempCheckData.my.shishi + 1
        elseif iteminfo.quality == "传说" then
            tempCheckData.my.chuanshuo = tempCheckData.my.chuanshuo + 1
        elseif iteminfo.quality == "神话" then
            tempCheckData.my.shenhua = tempCheckData.my.shenhua + 1
        end
    end

    for i, item in ipairs(myTradeInfo.item) do
        local iteminfo = ALL_BACKPACK_ITEMS[item[1]]
        if iteminfo.quality == "传说" then
            tempCheckData.my.chuanshuotuposhi = tempCheckData.my.chuanshuotuposhi + item[2]
        end
    end

    for i, equip in ipairs(targetTradeInfo.equip) do
        local iteminfo = ALL_BACKPACK_ITEMS[equip]
        if iteminfo.quality == "史诗" then
            tempCheckData.target.shishi = tempCheckData.target.shishi + 1
        elseif iteminfo.quality == "传说" then
            tempCheckData.target.chuanshuo = tempCheckData.target.chuanshuo + 1
        elseif iteminfo.quality == "神话" then
            tempCheckData.target.shenhua = tempCheckData.target.shenhua + 1
        end
    end

    for i, item in ipairs(targetTradeInfo.item) do
        local iteminfo = ALL_BACKPACK_ITEMS[item[1]]
        if iteminfo.quality == "传说" then
            tempCheckData.target.chuanshuotuposhi = tempCheckData.target.chuanshuotuposhi + item[2]
        end
    end

    local myFee = 0
    local targetFee = 0

    print(tempCheckData.my)
    print(tempCheckData.target)

    myFee = myFee + tempCheckData.target.chuanshuotuposhi * 50
    myFee = myFee + tempCheckData.target.shishi * 10
    myFee = myFee + tempCheckData.target.chuanshuo * 200
    myFee = myFee + tempCheckData.target.shenhua * 1000

    myFee = myFee - math.min(tempCheckData.target.chuanshuotuposhi, tempCheckData.my.chuanshuotuposhi) * 50 * 0.5
    myFee = myFee - math.min(tempCheckData.target.shishi, tempCheckData.my.shishi) * 10 * 0.5
    myFee = myFee - math.min(tempCheckData.target.chuanshuo, tempCheckData.my.chuanshuo) * 200 * 0.5
    myFee = myFee - math.min(tempCheckData.target.shenhua, tempCheckData.my.shenhua) * 1000 * 0.5

    targetFee = targetFee + tempCheckData.my.chuanshuotuposhi * 50
    targetFee = targetFee + tempCheckData.my.shishi * 10
    targetFee = targetFee + tempCheckData.my.chuanshuo * 200
    targetFee = targetFee + tempCheckData.my.shenhua * 1000

    targetFee = targetFee - math.min(tempCheckData.target.chuanshuotuposhi, tempCheckData.my.chuanshuotuposhi) * 50 *
                    0.5
    targetFee = targetFee - math.min(tempCheckData.target.shishi, tempCheckData.my.shishi) * 10 * 0.5
    targetFee = targetFee - math.min(tempCheckData.target.chuanshuo, tempCheckData.my.chuanshuo) * 200 * 0.5
    targetFee = targetFee - math.min(tempCheckData.target.shenhua, tempCheckData.my.shenhua) * 1000 * 0.5

    myTradeInfo.fee = myFee
    targetTradeInfo.fee = targetFee

    print(myFee)
    print(targetFee)
end

-- 将背包物品添加到左侧单元格中逻辑处理
local function addObjectToLeftCell(uid, elementId)
    if elementId ~= UI_ELEMENT.PANEL.items.ok and elementId ~= UI_ELEMENT.PANEL.right.ok then
        return
    end

    local itemid = localData.selectObjectId[uid]

    local tradeNo = currentTradeInfo[uid].tradeNo
    local role = currentTradeInfo[uid].role

    local tradeInfo = tradeList[tradeNo][role]
    local selectType = localData.selectMenuType[uid]

    if tradeInfo.lock then
        Player:notifyGameInfo2Self(uid, "你已锁定交易物品，无法添加物品")
        return
    end

    if selectType == 'items' then

        -- 限制交易類型
        if QualityLimitCheck(itemid) == false then
            Player:notifyGameInfo2Self(uid, "该道具属于不可交易品质")
            return
        end

        local _, playerInputItemsNum = VarLib2:getPlayerVarByName(uid, 3, "交易道具数量")
        -- 找一下道具在左边cell中的索引
        local itemLeftCellIndex = 0
        for i, leftCellItemObject in ipairs(tradeInfo.item) do
            if leftCellItemObject[1] == itemid then
                itemLeftCellIndex = i
            end
        end

        for i, itemObject in ipairs(tradeInfo.backpack.items) do
            if itemObject[1] == itemid then
                if itemObject[2] < playerInputItemsNum then
                    Player:notifyGameInfo2Self(uid, "你输入的数量大于你拥有的数量")
                    return
                end

                if #tradeInfo.item == 5 and itemLeftCellIndex == 0 then
                    Player:notifyGameInfo2Self(uid, "交易物品数量已满")
                    return
                end

                -- 移除交易背包中的道具
                if playerInputItemsNum == itemObject[2] then
                    table.remove(tradeInfo.backpack.items, i)
                else
                    itemObject[2] = itemObject[2] - playerInputItemsNum
                end

                -- 添加到左侧cell中 如果存在则添加数量
                if itemLeftCellIndex == 0 then
                    table.insert(tradeInfo.item, {itemid, playerInputItemsNum})
                else
                    tradeInfo.item[itemLeftCellIndex][2] = tradeInfo.item[itemLeftCellIndex][2] + playerInputItemsNum
                end

                break
            end
        end
    else
        local itemIndex = findIndex(tradeInfo.backpack.undressed[selectType], itemid)
        if itemIndex == nil then
            print('addObjectToLeftCell fail, 背包中不存在物品：' .. itemid)
            return
        end

        if #tradeInfo.equip == 5 then
            Player:notifyGameInfo2Self(uid, "交易物品数量已满")
            return
        end

        if QualityLimitCheck(itemid) == false then
            Player:notifyGameInfo2Self(uid, "该道具属于不可交易品质")
            return
        end

        table.remove(tradeInfo.backpack.undressed[selectType], itemIndex)
        table.insert(tradeInfo.equip, itemid)
    end

    caculateTradeFee(uid)
    handlePanelHide(uid)
    -- 处理完成后整理背包并显示交易面板UI(双方)
    showLeftTradeItemCell(tradeList[tradeNo].consumer.uid)
    showLeftTradeItemCell(tradeList[tradeNo].producer.uid)
    handleSortCells(uid)
    Customui:hideElement(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.items.panel)
    Customui:hideElement(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.right.panel)
    Customui:hideElement(uid, UI_ELEMENT.main, UI_ELEMENT.PANEL.right.tran)
end

-- 处理退出按钮逻辑··
local function handleQuitTrade(uid, elementId)
    if elementId == UI_ELEMENT.quit then
        Player:hideUIView(uid, UI_ELEMENT.main)
    end
end

-- 交易面板UI元素点击逻辑
local function handlePlayerClick(event)
    local uid = event.eventobjid
    local elementId = event.uielement

    handleNavMenusChange(uid, elementId)
    handleRightCellItemClick(uid, elementId)
    handleLeftCellItemClick(uid, elementId)
    handlePaginationLogic(uid, elementId)
    addObjectToLeftCell(uid, elementId)
    handlePanelHide(uid, elementId)
    lockPanel(uid, elementId)
    confirmTrade(uid, elementId)
    handleQuitTrade(uid, elementId)
end
ScriptSupportEvent:registerEvent('UI.Button.Click', handlePlayerClick)

local function handleUIClose(event)
    local uid = event.eventobjid
    local elementId = event.CustomUI

    if elementId == UI_ELEMENT.main then
        Buff:removeBuff(uid, 50000055)
    end

    local tradeNo = currentTradeInfo[uid].tradeNo

    local consumer = tradeList[tradeNo].consumer
    local producer = tradeList[tradeNo].producer

    localData.selectMenuType[consumer.uid] = nil
    localData.selectMenuType[producer.uid] = nil
    localData.pagination[consumer.uid] = nil
    localData.pagination[producer.uid] = nil
    localData.selectObjectId[consumer.uid] = nil
    localData.selectObjectId[producer.uid] = nil

    currentTradeInfo[consumer.uid] = nil
    currentTradeInfo[producer.uid] = nil
    Player:hideUIView(consumer.uid, UI_ELEMENT.main)
    Player:hideUIView(producer.uid, UI_ELEMENT.main)

    Player:notifyGameInfo2Self(consumer.uid, "交易已取消")
    Player:notifyGameInfo2Self(producer.uid, "交易已取消")

end
ScriptSupportEvent:registerEvent('UI.Hide', handleUIClose)

local function handleLeavueGame(event)
    local uid = event.eventobjid

    local tradeNo = currentTradeInfo[uid].tradeNo

    local consumer = tradeList[tradeNo].consumer
    local producer = tradeList[tradeNo].producer

    localData.selectMenuType[consumer.uid] = nil
    localData.selectMenuType[producer.uid] = nil
    localData.pagination[consumer.uid] = nil
    localData.pagination[producer.uid] = nil
    localData.selectObjectId[consumer.uid] = nil
    localData.selectObjectId[producer.uid] = nil

    currentTradeInfo[consumer.uid] = nil
    currentTradeInfo[producer.uid] = nil
    Player:hideUIView(consumer.uid, UI_ELEMENT.main)
    Player:hideUIView(producer.uid, UI_ELEMENT.main)

    Player:notifyGameInfo2Self(consumer.uid, "交易已取消")
    Player:notifyGameInfo2Self(producer.uid, "交易已取消")

end
ScriptSupportEvent:registerEvent('Game.AnyPlayer.LeaveGame', handleLeavueGame)
